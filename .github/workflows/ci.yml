name: cv-manager

on: [pull_request, push]   

jobs:
  build_api:
    runs-on: ubuntu-latest
    container:
      image: python:3.9
      options: --user root
    steps:
      - name: Checkout ${{ github.event.repository.name }}
        uses: actions/checkout@v3
      - name: Install dependencies
        run: |
          apt-get update
          apt-get -y install python3-coverage python3-pip python3-pytest
      - name: Install requirements
        run: python3 -m pip install -r $GITHUB_WORKSPACE/api/requirements.txt
      - name: Run tests
        continue-on-error: true
        run: |
          export PYTHONPATH=$PYTHONPATH:/usr/lib/python3/dist-packages
          cd $GITHUB_WORKSPACE/api/tests/
          python3 -m coverage run -m pytest --continue-on-collection-errors
          python3 -m coverage xml --omit="/opt/*,/root/*,/tmp/*,/usr/*,/var/*,**/__init__.py"
      - name: Archive code coverage results
        uses: actions/upload-artifact@v3
        with:
          name: API
          path: api/tests/coverage.xml
  webapp:
    runs-on: ubuntu-latest
    container:
      image: node:16.16.0
      options: --user root
      env:
        CI: true
    steps:
      - name: Checkout ${{ github.event.repository.name }}
        uses: actions/checkout@v3
      - name: Build
        run: |
          cd $GITHUB_WORKSPACE/webapp
          npm install -g nodemon
          npm init -y
          npm install --force
          npm test -- --coverage || true
      - name: Archive code coverage results
        uses: actions/upload-artifact@v3
        with:
          name: web-app-client
          path: web_app/coverage/*
          if-no-files-found: error          